# Google OAuth → メール認証 移行チェックリスト

このチェックリストは、Google OAuthからSupabaseメール認証への移行を確実に行うためのガイドです。

## 🔧 Phase 1: 事前準備

### Supabase設定の確認
- [ ] 現在のSupabaseプロジェクトが正常に動作している
- [ ] 既存のデータベース（profiles, problems, chat_histories）が正常
- [ ] 環境変数（`.env.local`）が正しく設定されている
- [ ] バックアップが作成されている（必要に応じて）

### 開発環境の準備
- [ ] Gitで現在の状態をコミット
- [ ] 新しいブランチを作成（例: `feature/email-auth-migration`）
- [ ] 依存関係が最新の状態

## 🛠️ Phase 2: Supabase設定変更

### Authentication設定
- [ ] Google OAuth設定を無効化
  - [ ] Authentication → Providers → Google → 「Enable sign in with Google」をオフ
- [ ] Email認証設定を確認・調整
  - [ ] Authentication → Providers → Email → 「Enable email confirmations」をオフ
- [ ] Site URLとRedirect URLを確認
  - [ ] 開発環境: `http://localhost:3000`, `http://localhost:3000/dashboard`
  - [ ] 本番環境（将来用）: 適切なURLを設定
- [ ] パスワード要件を設定
  - [ ] 最小8文字以上に設定

### セキュリティ設定の確認
- [ ] Row Level Security (RLS) ポリシーが正しく設定されている
- [ ] API keyが正しく設定されている

## 💻 Phase 3: コード変更

### AuthContext.tsx の更新
- [ ] `signInWithGoogle()` メソッドを削除
- [ ] `signInWithEmail(email: string, password: string)` メソッドを追加
- [ ] `AuthContextType` インターフェースを更新
- [ ] エラーハンドリングを適切に実装

### Login Page の更新
- [ ] Googleログインボタンを削除
- [ ] Email入力フィールドを追加
- [ ] Password入力フィールドを追加
- [ ] フォームバリデーションを実装
- [ ] エラーメッセージ表示を実装
- [ ] ローディング状態の管理を実装

### その他のファイル確認
- [ ] 他のコンポーネントでGoogle認証に依存している箇所がないか確認
- [ ] CLAUDE.mdの更新（認証方式の変更を反映）

## 👥 Phase 4: テストユーザー作成

### 管理者ユーザー
- [ ] Supabaseでテスト管理者ユーザーを作成
- [ ] profilesテーブルにレコード作成（is_admin: true）
- [ ] ログインテストが成功

### 一般ユーザー
- [ ] Supabaseでテスト一般ユーザーを作成
- [ ] profilesテーブルにレコード作成（is_admin: false）
- [ ] ログインテストが成功

## 🧪 Phase 5: 動作確認

### 基本機能テスト
- [ ] 管理者アカウントでログイン成功
- [ ] 一般ユーザーアカウントでログイン成功
- [ ] ログアウト機能が正常動作
- [ ] 存在しないユーザーでログイン失敗（適切なエラーメッセージ）
- [ ] 間違ったパスワードでログイン失敗（適切なエラーメッセージ）

### アプリケーション機能テスト
- [ ] ダッシュボードの表示
- [ ] 問題作成機能（/create-mcq）
- [ ] クイズ生成機能（/create-quiz）
- [ ] 問題保存機能
- [ ] 問題履歴表示
- [ ] 問題詳細表示（/problem/:id）

### 権限テスト
- [ ] 一般ユーザーは自分の問題のみ表示
- [ ] 管理者は適切な権限を持つ
- [ ] 未認証ユーザーは適切にリダイレクト

## 🚨 Phase 6: エラーハンドリング確認

### ネットワークエラー
- [ ] Supabaseとの接続エラー時の適切な表示
- [ ] タイムアウト時の適切な処理

### 認証エラー
- [ ] 無効なCredentials
- [ ] アカウントが存在しない
- [ ] パスワードが間違っている
- [ ] セッション期限切れ

### データエラー
- [ ] プロファイルが見つからない場合の処理
- [ ] 権限不足の場合の処理

## 📋 Phase 7: 本番準備

### コードレビュー
- [ ] セキュリティの観点でコードレビュー
- [ ] パフォーマンスの確認
- [ ] コードの品質確認

### ドキュメント更新
- [ ] CLAUDE.mdの認証部分を更新
- [ ] READMEの更新（必要に応じて）
- [ ] 運用マニュアルの作成

### 本番環境準備（将来用）
- [ ] 本番環境のSupabase設定
- [ ] 本番環境の環境変数設定
- [ ] 本番環境でのテスト

## ✅ Phase 8: 移行完了確認

### 最終チェック
- [ ] すべての機能が正常動作
- [ ] パフォーマンスに問題なし
- [ ] エラーログに異常なし
- [ ] ユーザビリティに問題なし

### クリーンアップ
- [ ] 不要なコードの削除
- [ ] コメントアウトされたコードの削除
- [ ] 未使用のimportの削除
- [ ] eslintエラーの解消

### デプロイメント
- [ ] テストブランチでの最終確認
- [ ] mainブランチへのマージ
- [ ] 本番環境へのデプロイ（将来用）

## 🔍 トラブルシューティング

### よくある問題と解決方法

**ログインできない**
1. Supabaseの設定確認（Email confirmationが無効か）
2. ユーザーが正しく作成されているか確認
3. profilesテーブルにレコードが存在するか確認

**権限が正しく動作しない**
1. profilesテーブルのis_adminフィールドを確認
2. RLSポリシーが正しく設定されているか確認
3. セッションが正しく更新されているか確認

**フォームバリデーションエラー**
1. Email形式が正しいか確認
2. パスワードが要件を満たしているか確認
3. 必須フィールドが入力されているか確認

## 📞 サポート

問題が発生した場合：
1. まずこのチェックリストを再確認
2. Supabaseダッシュボードでエラーログを確認
3. ブラウザの開発者ツールでエラーメッセージを確認
4. 必要に応じて関連ドキュメントを参照

---

**移行作業お疲れ様でした！** 🎉